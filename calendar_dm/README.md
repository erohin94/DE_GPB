–í —Ä–∞–º–∫–∞—Ö —Å–±–æ—Ä–∞ –≤–∏—Ç—Ä–∏–Ω—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –±—ã–ª–æ —Ä–∞—Å—á–∏—Ç–∞—Ç—å –∞—Ç—Ä–∏–±—É—Ç—ã.

–ï—Å—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Å –≤–∑–∞–∏–º–æ–¥–µ–π—Å–≤–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è user_id –∏ –æ–±—ä–µ–∫—Ç–∞ object_id. 

–í–∑–∞–∏–º–æ–¥–µ–π—Å–≤–∏—è –º–æ–≥—É—Ç –ø–æ –≤—Å—Ç—Ä–µ—á–∞–º, –ª–∞–π–∫–∞–º, –∑–≤–æ–Ω–∫–∞–º, –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—É.

–í–∏—Ç—Ä–∏–Ω–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é, –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ, –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω—ã—Ö.
–†–∞—Å—á–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–µ–ª–∞—Ç—å –∑–∞ 4 –Ω–µ–¥–µ–ª–∏. –¢–æ–µ—Å—Ç—å –µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≤–∏—Ç—Ä–∏–Ω—É –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, —Ç–æ –±–µ—Ä–µ–º —á–µ—Ç—ã—Ä–µ –ø—Ä–æ—à–µ–¥—à–∏—Ö –Ω–µ–¥–µ–ª–∏.
–í –≤–∏—Ç—Ä–∏–Ω–µ –æ—Ç—á–µ—Ç–Ω—ã–µ –Ω–µ–¥–µ–ª—è —ç—Ç–æ –∫–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏, —Ç–æ–µ—Å—Ç—å –≤–æ—Å—Ä–µ—Å–µ–Ω—å–µ.

–ù–∞–ø—Ä–∏–º–µ—Ä –æ–±–Ω–æ–≤–ª—è–µ–º –≤–∏—Ç—Ä–∏–Ω—É –≤ 03.11.2025, –∑–Ω–∞—á–∏—Ç –∏—â–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å–≤–∏—è –∑–∞ —á–µ—Ç—ã—Ä–µ –æ—Ç—á–µ—Ç–Ω—ã—Ö –Ω–µ–¥–µ–ª–∏ —Å 12.10.25, 19.10.25, 26.10.25, 02.11.25.
–í –æ—Ç—á–µ—Ç–Ω—É—é –Ω–µ–¥–µ–ª—é –≤—Ö–æ–¥—è—Ç –≤—Å–µ –≤–∑–∞–∏–º–æ–¥–∂–µ–π—Å–≤–∏—è —Å –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞ –ø–æ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ

–ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –±—ã–ª–æ —Å–ª–µ–¥—É—é—â–µ–µ. –î–ª—è –ø–∞—Ä—ã user_id - object_id, —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–ª—Å—è –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞—á–∏–Ω–∞—è —Å —Å–µ–Ω—Ç—è–±—Ä—è 2021 –≥–æ–¥–∞. –ò –∫—Ä–æ—Å—Å –¥–∂–æ–∏–Ω–∏–ª—Å—è –∫ –ø–∞—Ä–∞–º.
–ú–æ–≥–ª–æ –±—ã—Ç—å —Ç–∞–∫, —á—Ç–æ –¥–ª—è –∫–∞–∫–æ–π —Ç–æ –æ—Ç—á–µ—Ç–Ω–æ–π –¥—ã—Ç—ã –ø—Ä–æ—Å—Ç–æ –Ω–µ –±—ã–ª–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å–≤–∏—è –∏ —Å–æ–æ—Ç–≤—Ç—Å–≤–µ–Ω–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—å –¥–ª—è –Ω–∏—Ö –±—ã–ª –ª–∏—à–Ω–∏–π.
–¢–æ –µ—Å—Ç—å –±—ã–ª–æ —Å–ª–µ–¥—É—é—â–µ–µ

user_id object_id report_dt
1        2         05-09-2021
1        2         12-09-2021
1        2         19-09-2021
................
1        2         02-11-2025

–î–∞–ª–µ–µ –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–µ –∏—Å–∫–∞–ª–∏—Å—å –≤—Å–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å–≤–∏—è –∏ –¥–∂–æ–∏–Ω–∏–ª–∏—Å—å –∫ –æ—Ç—á–µ—Ç–Ω–æ–π –Ω–µ–¥–µ–ª–µ, –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –∏–∑ –∑–∞ —Ç–æ–≥–æ —á—Ç–æ –ø–∞—Ä –º–Ω–æ–≥–æ –ø–æ–ª—É—á–∞–ª–∞—Å—å –æ—á–µ–Ω—å –±–æ–ª—å—à–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∏ —Ç—è–∂–µ–ª—ã–π –∑–∞–ø—Ä–æ—Å, –≤–æ–∑–Ω–∏–∫–∞–ª spill.
–ü–æ—ç—Ç–æ–º—É –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ —Å–ª–µ–¥—É—é—â–µ–µ 


–ù–∏–∂–µ –ø—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞

üîπ –®–∞–≥–∏
–°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Å –¥–∏–∞–ø–∞–∑–æ–Ω–æ–º –¥–∞—Ç –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã (pairs).
–°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Å –∫–∞–ª–µ–Ω–¥–∞—Ä—ë–º –≤–Ω—É—Ç—Ä–∏ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (calendar_per_pair).
LEFT JOIN —Å —Ñ–∞–∫—Ç–∞–º–∏ –≤—Å—Ç—Ä–µ—á (meetings_with_calendar).
–§–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å –æ–∫–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π –¥–ª—è Sum_num_meetings.

üîπ –ü—Ä–∏–º–µ—Ä –Ω–∞ Impala

-- 1. –î–∏–∞–ø–∞–∑–æ–Ω—ã –ø–æ –∫–∞–∂–¥–æ–π –ø–∞—Ä–µ
CREATE TEMPORARY TABLE tmp_pairs AS
SELECT
    user_id,
    object_id,
    MIN(report_dt) AS min_dt,
    MAX(report_dt) AS max_dt
FROM meetings
GROUP BY user_id, object_id;


-- 2. –ö–∞–ª–µ–Ω–¥–∞—Ä—å –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã
CREATE TEMPORARY TABLE tmp_calendar_per_pair AS
SELECT
    p.user_id,
    p.object_id,
    c.report_dt AS calend_dt
FROM tmp_pairs p
JOIN calendar_full c
  ON c.report_dt BETWEEN p.min_dt AND p.max_dt;


-- 3. LEFT JOIN —Å —Ñ–∞–∫—Ç–∞–º–∏ –≤—Å—Ç—Ä–µ—á
CREATE TEMPORARY TABLE tmp_meetings_with_calendar AS
SELECT
    c.user_id,
    c.object_id,
    m.report_dt,
    c.calend_dt,
    m.num_meetings
FROM tmp_calendar_per_pair c
LEFT JOIN meetings m
  ON c.user_id = m.user_id
  AND c.object_id = m.object_id
  AND c.calend_dt = m.report_dt;


-- 4. –§–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å —Å—É–º–º–æ–π –∑–∞ 4 –Ω–µ–¥–µ–ª–∏
SELECT
    user_id,
    object_id,
    report_dt,
    calend_dt,
    num_meetings,
    SUM(num_meetings) OVER (
        PARTITION BY user_id, object_id
        ORDER BY calend_dt
        ROWS BETWEEN 3 PRECEDING AND CURRENT ROW
    ) AS Sum_num_meetings
FROM tmp_meetings_with_calendar
ORDER BY user_id, object_id, calend_dt;

üîπ –ß—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç—Å—è
–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∑–∞–º–µ–Ω—è—é—Ç CTE –∏ —Ö—Ä–∞–Ω—è—Ç –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.
–¢–∞–º, –≥–¥–µ –≤—Å—Ç—Ä–µ—á –Ω–µ—Ç, report_dt –∏ num_meetings –æ—Å—Ç–∞—é—Ç—Å—è NULL.
Sum_num_meetings —Å—á–∏—Ç–∞–µ—Ç —Å—É–º–º—É —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –≤—Å—Ç—Ä–µ—á –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 –Ω–µ–¥–µ–ª–∏ (–ø—Ä–æ–ø—É—Å–∫–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è).
–¢–∞–±–ª–∏—Ü–∞ –Ω–µ —Ä–∞–∑–¥—É–≤–∞–µ—Ç—Å—è –Ω–∞ –≤–µ—Å—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å 2021 –≥–æ–¥–∞, –∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤, –≥–¥–µ —Ä–µ–∞–ª—å–Ω–æ –µ—Å—Ç—å –≤—Å—Ç—Ä–µ—á–∏.






## –†–∞—Å—á—ë—Ç 4-–Ω–µ–¥–µ–ª—å–Ω—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –≤–∏—Ç—Ä–∏–Ω—ã –¥–∞–Ω–Ω—ã—Ö

**–ö–æ–Ω—Ç–µ–∫—Å—Ç**

–í —Ä–∞–º–∫–∞—Ö –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≤–∏—Ç—Ä–∏–Ω—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –∞—Ç—Ä–∏–±—É—Ç—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (`user_id`) —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ (`object_id`).
–ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –¥–∞–Ω–Ω—ã–µ –æ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–∞—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π ‚Äî –≤—Å—Ç—Ä–µ—á–∞—Ö, –ª–∞–π–∫–∞—Ö, –∑–≤–æ–Ω–∫–∞—Ö, –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è—Ö –∏ —Ç.–¥.

–í–∏—Ç—Ä–∏–Ω–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ, –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ (–±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö).
–ö–∞–∂–¥–∞—è –æ—Ç—á–µ—Ç–Ω–∞—è –Ω–µ–¥–µ–ª—è –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ–º, –∞ —Ä–∞—Å—á–µ—Ç –æ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 –æ—Ç—á–µ—Ç–Ω—ã–µ –Ω–µ–¥–µ–ª–∏.

**–ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á—ë—Ç–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞**

–ï—Å–ª–∏ –≤–∏—Ç—Ä–∏–Ω–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `03.11.2025` (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫), —Ç–æ –≤ —Ä–∞—Å—á–µ—Ç –≤–∫–ª—é—á–∞—é—Ç—Å—è 4 –ø—Ä–æ—à–µ–¥—à–∏–µ –Ω–µ–¥–µ–ª–∏:

```
–ù–µ–¥–µ–ª—è	–û—Ç—á–µ—Ç–Ω–∞—è –¥–∞—Ç–∞ (–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)	 –ü–µ—Ä–∏–æ–¥
1	      12.10.2025	                 06.10.2025 ‚Äì 12.10.2025
2	      19.10.2025	                 13.10.2025 ‚Äì 19.10.2025
3	      26.10.2025	                 20.10.2025 ‚Äì 26.10.2025
4	      02.11.2025	                 27.10.2025 ‚Äì 02.11.2025
```

**–ü—Ä–æ–±–ª–µ–º–∞ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞**

–†–∞–Ω–µ–µ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã `user_id` - `object_id` —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–ª—Å—è –ø–æ–ª–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞—á–∏–Ω–∞—è —Å —Å–µ–Ω—Ç—è–±—Ä—è 2021 –≥–æ–¥–∞, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –Ω–∞–ª–∏—á–∏—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π. 
–¢–æ–µ—Å—Ç—å –∫ –ø–∞—Ä–µ `user_id` - `object_id` –¥–µ–ª–∞–ª—Å—è CROSS JOIN –æ—Ç—á–µ—Ç–Ω—ã—Ö –Ω–µ–¥–µ–ª—å –Ω–∞—á–∏–Ω–∞—è —Å —Å–µ–Ω—Ç—è–±—Ä—è 2021 –≥–æ–¥–∞ –∏ –ø–æ —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É.

–ü—Ä–∏–º–µ—Ä –∏–∑–±—ã—Ç–æ—á–Ω–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è

```
user_id	object_id	 report_dt
1	      2	         05.09.2021
1	      2	         12.09.2021
1	      2	         19.09.2021
...	...	...
1	      2	         02.11.2025
```

–î–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞–ª –≤—Å–µ–≥–æ 3 —Ä–∞–∑–∞ –∑–∞ –≤–µ—Å—å –ø–µ—Ä–∏–æ–¥, —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å —Å–æ—Ç–Ω–∏ "–ø—É—Å—Ç—ã—Ö" —Å—Ç—Ä–æ–∫.
–ü—Ä–∏ –¥–∂–æ–π–Ω–µ —Å —Ñ–∞–∫—Ç–∞–º–∏ (`meetings`) —Ç–∞–±–ª–∏—Ü–∞ —Ä–∞–∑—Ä–∞—Å—Ç–∞–ª–∞—Å—å –¥–æ –¥–µ—Å—è—Ç–∫–æ–≤ –º–∏–ª–ª–∏–æ–Ω–æ–≤ —Å—Ç—Ä–æ–∫, –∏ –≤ Impala –ø–æ—è–≤–ª—è–ª—Å—è spill.

**–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ**

–¢–µ–ø–µ—Ä—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–∞—Ä—ã.
–≠—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —Å–Ω–∏–∂–∞–µ—Ç –æ–±—ä—ë–º –¥–∞–Ω–Ω—ã—Ö –∏ —É—Å–∫–æ—Ä—è–µ—Ç —Ä–∞—Å—á—ë—Ç—ã.

**–®–∞–≥ 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –ø–æ –∫–∞–∂–¥–æ–π –ø–∞—Ä–µ**

```
-- –£–¥–∞–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É, –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
DROP TABLE IF EXISTS sandbox_hr.tmp_pairs;
/
/* –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ –ø–∞—Ä–∞–º */
CREATE TABLE IF NOT EXISTS sandbox_hr.tmp_pairs (
                                                  user_id INT COMMENT '–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
                                                  object_id INT COMMENT '–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –æ–±—ä–µ–∫—Ç–∞',
                                                  min_dt DATE COMMENT '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è',
                                                  max_dt DATE COMMENT '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è'
                                                )
COMMENT '–î–∏–∞–ø–∞–∑–æ–Ω –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ –∫–∞–∂–¥–æ–π –ø–∞—Ä–µ user_id - object_id'
STORED AS PARQUET
/

/* –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ */
INSERT INTO sandbox_hr.tmp_pairs
SELECT
    user_id,
    object_id,
    MIN(report_dt) AS min_dt,
    MAX(report_dt) AS max_dt
FROM sandbox_hr.meetings
GROUP BY user_id, object_id
/
COMPUTE STATS sandbox_hr.tmp_pairs /* –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è */
/

```

–ü—Ä–∏–º–µ—Ä:

```
user_id	object_id	min_dt	max_dt
1	2	01.09.2025	02.11.2025
2	3	08.09.2025	12.10.2025
```

**–®–∞–≥ 2. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –≤–Ω—É—Ç—Ä–∏ –¥–∏–∞–ø–∞–∑–æ–Ω–∞**

```
DROP TABLE IF EXISTS sandbox_hr.tmp_calendar_per_pair;
/
CREATE TABLE IF NOT EXISTS sandbox_hr.tmp_calendar_per_pair (
                                                              user_id INT COMMENT '–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
                                                              object_id INT COMMENT '–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –æ–±—ä–µ–∫—Ç–∞',
                                                              calend_dt DATE COMMENT '–û—Ç—á–µ—Ç–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ–¥–µ–ª–∏ (–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)'
                                                            )
COMMENT '–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–µ–¥–µ–ª—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã'
STORED AS PARQUET
/

INSERT INTO sandbox_hr.tmp_calendar_per_pair
SELECT
    p.user_id,
    p.object_id,
    c.report_dt AS calend_dt
FROM sandbox_hr.tmp_pairs p
JOIN sandbox_hr.calendar_full c
  ON c.report_dt BETWEEN p.min_dt AND p.max_dt
/
COMPUTE STATS sandbox_hr.tmp_calendar_per_pair
/

```

```
–ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:

user_id	object_id	calend_dt
1	2	07.09.2025
1	2	14.09.2025
1	2	21.09.2025
1	2	28.09.2025
1	2	05.10.2025
...	...	...
```

–ó–¥–µ—Å—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–º–∫–∞—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –ø–∞—Ä—ã.

**–®–∞–≥ 3. –î–∂–æ–π–Ω —Å —Ñ–∞–∫—Ç–∞–º–∏ –≤—Å—Ç—Ä–µ—á**

```
DROP TABLE IF EXISTS sandbox_hr.tmp_meetings_with_calendar;
/


CREATE TABLE IF NOT EXISTS sandbox_hr.tmp_meetings_with_calendar (
    user_id       INT COMMENT '–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
    object_id     INT COMMENT '–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –æ–±—ä–µ–∫—Ç–∞',
    report_dt     DATE COMMENT '–î–∞—Ç–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è',
    calend_dt     DATE COMMENT '–û—Ç—á–µ—Ç–Ω–∞—è –¥–∞—Ç–∞ (–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)',
    num_meetings  BIGINT COMMENT '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Å—Ç—Ä–µ—á –∑–∞ –Ω–µ–¥–µ–ª—é'
)
COMMENT '–ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º —Ñ–∞–∫—Ç–æ–≤ –≤—Å—Ç—Ä–µ—á'
STORED AS PARQUET
/


INSERT INTO sandbox_hr.tmp_meetings_with_calendar
SELECT
    c.user_id,
    c.object_id,
    m.report_dt,
    c.calend_dt,
    m.num_meetings
FROM sandbox_hr.tmp_calendar_per_pair c
LEFT JOIN sandbox_hr.meetings m
  ON c.user_id = m.user_id
  AND c.object_id = m.object_id
  AND c.calend_dt = m.report_dt
/


COMPUTE STATS sandbox_hr.tmp_meetings_with_calendar
/
```


–ü—Ä–∏–º–µ—Ä –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∏ —Ñ–∞–∫—Ç–æ–≤:
```
user_id	object_id	calend_dt	num_meetings
1	2	07.09.2025	3
1	2	14.09.2025	NULL
1	2	21.09.2025	1
1	2	28.09.2025	2
1	2	05.10.2025	NULL
1	2	12.10.2025	4
```

**–®–∞–≥ 4. –†–∞—Å—á–µ—Ç —Å—É–º–º—ã –∑–∞ 4 –Ω–µ–¥–µ–ª–∏ (—Å–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ)**


```
–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á–µ—Ç–∞:

user_id	object_id	calend_dt	num_meetings	sum_num_meetings
1	2	07.09.2025	3	3
1	2	14.09.2025	NULL	3
1	2	21.09.2025	1	4
1	2	28.09.2025	2	6
1	2	05.10.2025	NULL	6
1	2	12.10.2025	4	7
```

–¢–µ–ø–µ—Ä—å –∞—Ç—Ä–∏–±—É—Ç sum_num_meetings –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Å—Ç—Ä–µ—á –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 –Ω–µ–¥–µ–ª–∏ (–≤–∫–ª—é—á–∞—è —Ç–µ–∫—É—â—É—é).


```
DROP TABLE IF EXISTS sandbox_hr.tmp_meetings_sum_4w;
/


CREATE TABLE IF NOT EXISTS sandbox_hr.tmp_meetings_sum_4w (
    user_id            INT COMMENT '–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
    object_id          INT COMMENT '–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –æ–±—ä–µ–∫—Ç–∞',
    calend_dt          DATE COMMENT '–û—Ç—á–µ—Ç–Ω–∞—è –Ω–µ–¥–µ–ª—è (–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)',
    num_meetings       BIGINT COMMENT '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Å—Ç—Ä–µ—á –∑–∞ –Ω–µ–¥–µ–ª—é',
    sum_num_meetings   BIGINT COMMENT '–°—É–º–º–∞ –≤—Å—Ç—Ä–µ—á –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 –Ω–µ–¥–µ–ª–∏'
)
COMMENT '–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á—ë—Ç–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤—Å—Ç—Ä–µ—á –∑–∞ 4 –æ—Ç—á–µ—Ç–Ω—ã–µ –Ω–µ–¥–µ–ª–∏'
STORED AS PARQUET
/


INSERT INTO sandbox_hr.tmp_meetings_sum_4w
SELECT
    user_id,
    object_id,
    calend_dt,
    num_meetings,
    SUM(num_meetings) OVER (
        PARTITION BY user_id, object_id
        ORDER BY calend_dt
        ROWS BETWEEN 3 PRECEDING AND CURRENT ROW
    ) AS sum_num_meetings
FROM sandbox_hr.tmp_meetings_with_calendar
ORDER BY user_id, object_id, calend_dt
/


COMPUTE STATS sandbox_hr.tmp_meetings_sum_4w
/

```


